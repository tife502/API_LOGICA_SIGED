# üîê SISTEMA DE AUTENTICACI√ìN - DOCUMENTACI√ìN COMPLETA

## üìã Tabla de Contenidos

1. [Descripci√≥n General](#descripci√≥n-general)
2. [Arquitectura del Sistema](#arquitectura-del-sistema)
3. [Endpoints de Autenticaci√≥n](#endpoints-de-autenticaci√≥n)
4. [Tokens JWT](#tokens-jwt)
5. [Middleware de Autorizaci√≥n](#middleware-de-autorizaci√≥n)
6. [Ejemplos de Uso](#ejemplos-de-uso)
7. [Seguridad y Mejores Pr√°cticas](#seguridad-y-mejores-pr√°cticas)
8. [Casos de Prueba](#casos-de-prueba)

---

## üéØ Descripci√≥n General

El **Sistema de Autenticaci√≥n** de SIGED implementa un mecanismo robusto y seguro basado en **JWT (JSON Web Tokens)** con tokens de acceso y refresh tokens, proporcionando control granular de acceso y gesti√≥n de sesiones.

### üîë **Funcionalidades Principales**

- ‚úÖ **Autenticaci√≥n JWT**: Login seguro con tokens de acceso y refresh
- ‚úÖ **Autorizaci√≥n por Roles**: Control granular con 3 niveles de permisos
- ‚úÖ **Gesti√≥n de Sesiones**: Logout y invalidaci√≥n de tokens
- ‚úÖ **Refresh Tokens**: Renovaci√≥n autom√°tica de sesiones
- ‚úÖ **Middleware de Seguridad**: Protecci√≥n de rutas por rol
- ‚úÖ **Token Blacklist**: Control de tokens revocados

---

## üèóÔ∏è Arquitectura del Sistema

```
auth/
‚îú‚îÄ‚îÄ üìÅ auth.controller.ts          # Controlador de autenticaci√≥n
‚îú‚îÄ‚îÄ üìÅ auth.routes.ts              # Rutas de auth
‚îî‚îÄ‚îÄ üìÅ [relacionados]
    ‚îú‚îÄ‚îÄ auth.middleware.ts         # Middleware de autorizaci√≥n
    ‚îú‚îÄ‚îÄ jwt.service.ts             # Servicio JWT
    ‚îî‚îÄ‚îÄ token-blacklist.service.ts # Gesti√≥n de tokens revocados
```

### üåê **Flujo de Autenticaci√≥n**

```mermaid
sequenceDiagram
    participant Cliente
    participant API
    participant JWT
    participant DB
    
    Cliente->>API: POST /auth/login
    API->>DB: Verificar credenciales
    DB-->>API: Usuario v√°lido
    API->>JWT: Generar access + refresh token
    JWT-->>API: Tokens generados
    API-->>Cliente: Tokens + info usuario
    
    Cliente->>API: Request con Authorization header
    API->>JWT: Verificar access token
    JWT-->>API: Token v√°lido
    API-->>Cliente: Respuesta autorizada
```

---

## üõ£Ô∏è Endpoints de Autenticaci√≥n

### **üîì Iniciar Sesi√≥n**
```http
POST /api/auth/login
```
**Acceso**: P√∫blico

**Body**:
```json
{
  "documento": "12345678",
  "contrasena": "MiContrasena123"
}
```

**Respuesta Exitosa**:
```json
{
  "success": true,
  "message": "Autenticaci√≥n exitosa",
  "data": {
    "usuario": {
      "id": "uuid-usuario",
      "nombre": "Juan Carlos",
      "apellido": "P√©rez Garc√≠a", 
      "email": "juan.perez@example.com",
      "documento": "12345678",
      "rol": "admin",
      "estado": "activo"
    },
    "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "refreshToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "expiresIn": "2h"
  }
}
```

**Respuesta de Error**:
```json
{
  "success": false,
  "message": "Credenciales inv√°lidas",
  "error": "Invalid Credentials"
}
```

### **üîÑ Renovar Token**
```http
POST /api/auth/refresh
```
**Acceso**: P√∫blico (requiere refresh token v√°lido)

**Headers**:
```
Authorization: Bearer {refreshToken}
```

**Respuesta**:
```json
{
  "success": true,
  "message": "Token renovado exitosamente",
  "data": {
    "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "expiresIn": "2h"
  }
}
```

### **üë§ Obtener Informaci√≥n del Usuario**
```http
GET /api/auth/me
```
**Acceso**: Privado (requiere access token)

**Headers**:
```
Authorization: Bearer {accessToken}
```

**Respuesta**:
```json
{
  "success": true,
  "data": {
    "id": "uuid-usuario",
    "nombre": "Juan Carlos",
    "apellido": "P√©rez Garc√≠a",
    "email": "juan.perez@example.com", 
    "documento": "12345678",
    "rol": "admin",
    "estado": "activo",
    "ultimoAcceso": "2025-10-07T12:00:00.000Z"
  }
}
```

### **üö™ Cerrar Sesi√≥n**
```http
POST /api/auth/logout
```
**Acceso**: Privado (requiere access token)

**Headers**:
```
Authorization: Bearer {accessToken}
```

**Respuesta**:
```json
{
  "success": true,
  "message": "Sesi√≥n cerrada exitosamente"
}
```

### **üîê Cambiar Contrase√±a (Autenticado)**
```http
POST /api/auth/change-password
```
**Acceso**: Privado (requiere access token)

**Body**:
```json
{
  "contrasenaActual": "MiContrasenaActual123",
  "nuevaContrasena": "MiNuevaContrasena456"
}
```

**Respuesta**:
```json
{
  "success": true,
  "message": "Contrase√±a cambiada exitosamente"
}
```

---

## üé´ Tokens JWT

### **Estructura del Access Token**

```json
{
  "header": {
    "alg": "HS256",
    "typ": "JWT"
  },
  "payload": {
    "id": "uuid-usuario",
    "documento": "12345678",
    "email": "juan.perez@example.com",
    "rol": "admin",
    "estado": "activo",
    "iat": 1696680000,
    "exp": 1696687200
  },
  "signature": "..."
}
```

### **Estructura del Refresh Token**

```json
{
  "payload": {
    "id": "uuid-usuario",
    "tipo": "refresh",
    "iat": 1696680000,
    "exp": 1699272000
  }
}
```

### **Configuraci√≥n de Tokens**

| Token Type | Duraci√≥n | Uso |
|------------|----------|-----|
| **Access Token** | 2 horas | Autenticaci√≥n de requests |
| **Refresh Token** | 30 d√≠as | Renovaci√≥n de access tokens |

---

## üõ°Ô∏è Middleware de Autorizaci√≥n

### **authMiddleware**
Verifica la validez del access token y extrae informaci√≥n del usuario.

```typescript
// Uso b√°sico
router.use(authMiddleware);

// El middleware agrega req.usuario con:
interface UsuarioAutenticado {
  id: string;
  documento: string;
  email: string;
  rol: 'super_admin' | 'admin' | 'gestor';
  estado: 'activo' | 'inactivo' | 'suspendido';
}
```

### **roleMiddleware**
Controla acceso por roles espec√≠ficos.

```typescript
// Solo super_admin y admin
router.use(roleMiddleware(['super_admin', 'admin']));

// Solo super_admin
router.use(roleMiddleware(['super_admin']));

// Todos los roles (equivalente a solo authMiddleware)
router.use(roleMiddleware(['super_admin', 'admin', 'gestor']));
```

### **canModifyUserMiddleware**
Controla qui√©n puede modificar usuarios espec√≠ficos.

```typescript
// Permite:
// - super_admin: puede modificar cualquier usuario
// - admin: puede modificar admin y gestor (no super_admin)
// - gestor: solo puede modificar su propio usuario
router.use(canModifyUserMiddleware);
```

### **Ejemplo de Uso en Rutas**

```typescript
// Ruta p√∫blica
router.post('/login', AuthController.login);

// Ruta privada b√°sica
router.get('/me', 
  authMiddleware, 
  AuthController.me
);

// Ruta con control de roles
router.post('/usuario', 
  authMiddleware,
  roleMiddleware(['super_admin', 'admin']),
  UsuarioController.createUsuario
);

// Ruta con control jer√°rquico
router.put('/usuario/:id',
  authMiddleware,
  canModifyUserMiddleware,
  UsuarioController.updateUsuario
);
```

---

## üß™ Ejemplos de Uso Completos

### **Flujo 1: Autenticaci√≥n Completa**

```bash
# 1. Login inicial
curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "documento": "12345678",
    "contrasena": "MiContrasena123"
  }'

# Guardar tokens de la respuesta
ACCESS_TOKEN="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
REFRESH_TOKEN="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."

# 2. Usar access token para requests autenticados
curl -X GET http://localhost:3000/api/auth/me \
  -H "Authorization: Bearer $ACCESS_TOKEN"

# 3. Renovar token cuando expire
curl -X POST http://localhost:3000/api/auth/refresh \
  -H "Authorization: Bearer $REFRESH_TOKEN"

# 4. Logout
curl -X POST http://localhost:3000/api/auth/logout \
  -H "Authorization: Bearer $ACCESS_TOKEN"
```

### **Flujo 2: Manejo de Expiraci√≥n**

```bash
# Request con token expirado
curl -X GET http://localhost:3000/api/usuario \
  -H "Authorization: Bearer $EXPIRED_TOKEN"

# Respuesta: 401 Unauthorized
{
  "success": false,
  "message": "Token expirado",
  "error": "Token Expired"
}

# Renovar con refresh token
curl -X POST http://localhost:3000/api/auth/refresh \
  -H "Authorization: Bearer $REFRESH_TOKEN"

# Usar nuevo access token
NEW_ACCESS_TOKEN="..."
curl -X GET http://localhost:3000/api/usuario \
  -H "Authorization: Bearer $NEW_ACCESS_TOKEN"
```

### **Flujo 3: Control de Roles**

```bash
# Gestor intentando crear usuario (sin permisos)
curl -X POST http://localhost:3000/api/usuario \
  -H "Authorization: Bearer $GESTOR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"nombre": "Test"}'

# Respuesta: 403 Forbidden
{
  "success": false,
  "message": "No tienes permisos para realizar esta acci√≥n",
  "error": "Insufficient Permissions"
}

# Admin creando usuario (con permisos)
curl -X POST http://localhost:3000/api/usuario \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "documento": "87654321",
    "nombre": "Nuevo Usuario",
    "contrasena": "Password123"
  }'
```

---

## üîí Seguridad y Mejores Pr√°cticas

### **Configuraci√≥n de Seguridad**

```bash
# Variables de entorno requeridas
JWT_SECRET=tu-clave-secreta-muy-larga-y-compleja-para-produccion
JWT_EXPIRES_IN=2h
JWT_REFRESH_SECRET=otra-clave-secreta-diferente-para-refresh-tokens
JWT_REFRESH_EXPIRES_IN=30d
```

### **Validaciones de Seguridad**

#### **Contrase√±as**
- ‚úÖ M√≠nimo 8 caracteres
- ‚úÖ Al menos una may√∫scula (A-Z)
- ‚úÖ Al menos una min√∫scula (a-z) 
- ‚úÖ Al menos un n√∫mero (0-9)
- ‚úÖ Hash bcrypt con 12 rondas

#### **Tokens**
- ‚úÖ Algoritmo HS256 para firmado
- ‚úÖ Verificaci√≥n de expiraci√≥n
- ‚úÖ Validaci√≥n de formato
- ‚úÖ Blacklist para tokens revocados

#### **Usuarios**
- ‚úÖ Verificaci√≥n de estado activo
- ‚úÖ Control de roles jer√°rquicos
- ‚úÖ Prevenci√≥n de escalada de privilegios

### **Headers de Seguridad**

```typescript
// Headers requeridos para requests autenticados
const headers = {
  'Authorization': 'Bearer {accessToken}',
  'Content-Type': 'application/json'
};

// El sistema NO requiere:
// - API Keys adicionales
// - CSRF tokens (API stateless)
// - Cookies de sesi√≥n
```

---

## üîÑ Casos de Prueba

### **Caso 1: Login con Credenciales Inv√°lidas**

```bash
# ‚ùå Usuario inexistente
curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "documento": "99999999",
    "contrasena": "cualquier"
  }'

# Respuesta esperada:
{
  "success": false,
  "message": "Usuario no encontrado",
  "error": "User Not Found"
}

# ‚ùå Contrase√±a incorrecta  
curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "documento": "12345678",
    "contrasena": "incorrecta"
  }'

# Respuesta esperada:
{
  "success": false,
  "message": "Contrase√±a incorrecta",  
  "error": "Invalid Password"
}
```

### **Caso 2: Usuario Inactivo**

```bash
# ‚ùå Usuario con estado inactivo
curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "documento": "87654321",
    "contrasena": "contrasena123"
  }'

# Respuesta esperada:
{
  "success": false,
  "message": "Usuario inactivo. Contacta al administrador",
  "error": "Inactive User"
}
```

### **Caso 3: Token Malformado**

```bash
# ‚ùå Token inv√°lido
curl -X GET http://localhost:3000/api/auth/me \
  -H "Authorization: Bearer token-malformado"

# Respuesta esperada: 401 Unauthorized
{
  "success": false,
  "message": "Token inv√°lido",
  "error": "Invalid Token"
}

# ‚ùå Sin token
curl -X GET http://localhost:3000/api/auth/me

# Respuesta esperada: 401 Unauthorized  
{
  "success": false,
  "message": "Token de acceso requerido",
  "error": "No Token Provided"
}
```

### **Caso 4: Refresh Token Expirado**

```bash
# ‚ùå Refresh token expirado
curl -X POST http://localhost:3000/api/auth/refresh \
  -H "Authorization: Bearer {expired_refresh_token}"

# Respuesta esperada: 401 Unauthorized
{
  "success": false,
  "message": "Refresh token expirado. Inicia sesi√≥n nuevamente",
  "error": "Refresh Token Expired"
}
```

---

## üöÄ Caracter√≠sticas Avanzadas

### **Token Blacklist**
Sistema para invalidar tokens antes de su expiraci√≥n natural.

```typescript
// Cuando un usuario hace logout:
// 1. El access token se agrega a la blacklist
// 2. Requests futuros con ese token son rechazados
// 3. La blacklist se limpia autom√°ticamente de tokens expirados
```

### **Renovaci√≥n Autom√°tica**
Los clientes pueden implementar renovaci√≥n autom√°tica de tokens.

```javascript
// Ejemplo de interceptor para renovaci√≥n autom√°tica
axios.interceptors.response.use(
  (response) => response,
  async (error) => {
    if (error.response?.status === 401) {
      // Token expirado, intentar renovar
      const newToken = await refreshToken();
      if (newToken) {
        // Reintentar request con nuevo token
        error.config.headers.Authorization = `Bearer ${newToken}`;
        return axios.request(error.config);
      }
    }
    return Promise.reject(error);
  }
);
```

### **Logging de Seguridad**
Registro detallado de eventos de autenticaci√≥n.

```typescript
// Se registran eventos como:
// - Intentos de login exitosos/fallidos
// - Renovaci√≥n de tokens  
// - Accesos con tokens expirados
// - Intentos de escalada de privilegios
```

---

## ‚öôÔ∏è Configuraci√≥n Recomendada

### **Desarrollo**
```bash
JWT_SECRET=desarrollo-secret-key-no-usar-en-produccion
JWT_EXPIRES_IN=8h
JWT_REFRESH_SECRET=desarrollo-refresh-secret
JWT_REFRESH_EXPIRES_IN=7d
```

### **Producci√≥n**
```bash
JWT_SECRET=clave-ultra-secreta-de-al-menos-64-caracteres-aleatorios
JWT_EXPIRES_IN=2h
JWT_REFRESH_SECRET=otra-clave-diferente-igual-de-compleja
JWT_REFRESH_EXPIRES_IN=30d
```

### **Recomendaciones**
- üîê Usar claves de al menos 64 caracteres
- üîÑ Rotar claves peri√≥dicamente
- üìù Mantener logs de acceso
- üõ°Ô∏è Implementar rate limiting en login
- üîí Usar HTTPS en producci√≥n

---

*Documentaci√≥n del Sistema de Autenticaci√≥n - API SIGED*  
*√öltima actualizaci√≥n: Octubre 2025*  
*Versi√≥n: 1.0.0 - JWT con refresh tokens y control de roles*